{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-6" x-data="{ selectedInstrument: null, selectedStaging: null }">
    
    <!-- Header: Payment Details -->
    <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-6 border border-gray-700">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-2xl font-bold text-white mb-2">Conciliación Manual</h1>
                <p class="text-gray-400">Cliente: <span class="text-white font-semibold">{{ pago.DescripClie }}</span></p>
                <p class="text-gray-400">ID Pago: <span class="text-gray-300">{{ pago.idPago }}</span></p>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-400">Monto Total Reportado</p>
                <p class="text-3xl font-bold text-green-400">
                    {{ "{:,.2f}".format(pago.MontoPago) }} {{ pago.instrumentos[0].moneda if pago.instrumentos else '' }}
                </p>
                <p class="text-sm text-gray-400 mt-1">Fecha: {{ pago.fecha.strftime('%d/%m/%Y') }}</p>
            </div>
        </div>
    </div>

    <!-- Affected Documents Section -->
    <div class="bg-gray-800 rounded-lg shadow-lg border border-gray-700 mb-6 overflow-hidden" x-data="{ expanded: {{ 'true' if pago.documentos else 'false' }} }">
        <div @click="expanded = !expanded" class="p-4 bg-gray-900 border-b border-gray-700 flex justify-between items-center cursor-pointer hover:bg-gray-750 transition-colors">
            <h2 class="text-lg font-semibold text-gray-200 flex items-center">
                <span class="material-symbols-outlined mr-2">description</span>
                Documentos Afectados ({{ pago.documentos|length }})
            </h2>
            <span class="material-symbols-outlined text-gray-400 transform transition-transform" :class="{'rotate-180': expanded}">expand_more</span>
        </div>
        
        <div x-show="expanded" class="overflow-x-auto p-4">
            {% if pago.documentos %}
            <table class="w-full text-sm text-left text-gray-300">
                <thead class="text-xs text-gray-400 uppercase bg-gray-700/50">
                    <tr>
                        <th class="px-4 py-2 rounded-tl-lg">Tipo</th>
                        <th class="px-4 py-2">Documento</th>
                        <th class="px-4 py-2 text-right">Monto Original</th>
                        <th class="px-4 py-2 text-right">Descuento</th>
                        <th class="px-4 py-2 text-right">Retención</th>
                        <th class="px-4 py-2 text-right rounded-tr-lg">Neto a Pagar</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-700">
                    {% for doc in pago.documentos %}
                    <tr class="hover:bg-gray-700/30">
                        <td class="px-4 py-3 font-medium">{{ doc.tipoDoc }}</td>
                        <td class="px-4 py-3 font-mono text-white">{{ doc.numeroDoc }}</td>
                        <td class="px-4 py-3 text-right">{{ "{:,.2f}".format(doc.montoDoc) }}</td>
                        <td class="px-4 py-3 text-right text-green-400">
                            {% if doc.montoDescuento > 0 %}
                                - {{ "{:,.2f}".format(doc.montoDescuento) }} <span class="text-xs">({{ doc.porcentajeDescuento }}%)</span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-right text-yellow-400">
                            {% if doc.montoRetencion > 0 %}
                                - {{ "{:,.2f}".format(doc.montoRetencion) }} <span class="text-xs">({{ doc.porcentajeRetencion }}%)</span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-right font-bold text-white">
                            {{ "{:,.2f}".format(doc.montoDoc - doc.montoDescuento - doc.montoRetencion) }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="text-center py-4 text-gray-500">
                No hay documentos asociados a este pago.
            </div>
            {% endif %}
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- Left Column: Instruments (Portal) -->
        <div class="bg-gray-800 rounded-lg shadow-lg border border-gray-700 flex flex-col h-[calc(100vh-300px)]">
            <div class="p-4 border-b border-gray-700 bg-gray-900 rounded-t-lg">
                <h2 class="text-lg font-semibold text-purple-400 flex items-center">
                    <span class="material-symbols-outlined mr-2">receipt_long</span>
                    Instrumentos de Pago (Portal)
                </h2>
                <p class="text-xs text-gray-500 mt-1">Selecciona un instrumento para buscar coincidencias</p>
            </div>
            
            <div class="overflow-y-auto flex-1 p-2 space-y-2">
                {% for instr in instruments_view %}
                <div 
                    @click="selectedInstrument = '{{ instr.id }}'; $dispatch('instrument-selected', {id: '{{ instr.id }}', amount: '{{ instr.amount_base }}', bank: '{{ instr.erp_bank_code }}'})"
                    :class="{'ring-2 ring-purple-500 bg-gray-700': selectedInstrument === '{{ instr.id }}', 'bg-gray-800 hover:bg-gray-700': selectedInstrument !== '{{ instr.id }}'}"
                    class="p-4 rounded-lg border border-gray-600 cursor-pointer transition-all duration-200"
                >
                    <div class="flex justify-between items-center mb-2">
                        <span class="px-2 py-1 bg-blue-900 text-blue-200 text-xs rounded-full">{{ instr.forma_pago }}</span>
                        <span class="text-sm text-gray-400">{{ instr.fecha.strftime('%d/%m/%Y') }}</span>
                    </div>
                    
                    <div class="flex justify-between items-baseline">
                        <div>
                            <p class="text-sm text-gray-300 font-medium">{{ instr.banco_origen }}</p>
                            <p class="text-xs text-gray-500">Ref: {{ instr.referencia }}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-white">{{ "{:,.2f}".format(instr.amount_orig) }} <span class="text-xs">{{ instr.currency_orig }}</span></p>
                            {% if instr.currency_orig != system_base_currency %}
                            <p class="text-xs text-yellow-500">
                                ≈ {{ "{:,.2f}".format(instr.amount_base) }} {{ system_base_currency }}
                            </p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Mapping Info -->
                    <div class="mt-2 pt-2 border-t border-gray-600 flex justify-between items-center text-xs">
                        <span class="text-gray-400">Banco Destino (ERP):</span>
                        {% if instr.erp_bank_code %}
                            <span class="text-green-400 font-mono">{{ instr.erp_bank_desc }} ({{ instr.erp_bank_code }})</span>
                        {% else %}
                            <span class="text-red-400 flex items-center">
                                <span class="material-symbols-outlined text-sm mr-1">warning</span>
                                Sin Mapeo
                            </span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Right Column: Staging Transactions (Bank) -->
        <div class="bg-gray-800 rounded-lg shadow-lg border border-gray-700 flex flex-col h-[calc(100vh-300px)]">
            <div class="p-4 border-b border-gray-700 bg-gray-900 rounded-t-lg flex justify-between items-center">
                <div>
                    <h2 class="text-lg font-semibold text-blue-400 flex items-center">
                        <span class="material-symbols-outlined mr-2">account_balance</span>
                        Movimientos Bancarios (ERP)
                    </h2>
                    <p class="text-xs text-gray-500 mt-1">Coincidencias sugeridas</p>
                </div>
                <!-- Manual Search Filter -->
                 <div class="flex space-x-2" x-show="selectedInstrument">
                    <button 
                        hx-get="/reconciliation/search-matches"
                        hx-include="[name='search_ref']"
                        hx-target="#staging-list"
                        class="p-1 bg-gray-700 rounded hover:bg-gray-600 text-gray-300"
                        title="Actualizar búsqueda"
                    >
                        <span class="material-symbols-outlined text-sm">refresh</span>
                    </button>
                </div>
            </div>

            <!-- HTMX Container for Staging Matches -->
            <div id="staging-list" 
                 class="overflow-y-auto flex-1 p-2 space-y-2 relative"
                 hx-trigger="instrument-selected from:body"
                 hx-get="/reconciliation/search-matches"
                 hx-vals='js:{instrument_id: event.detail.id}'
                 hx-swap="innerHTML"
            >
                <div class="flex flex-col items-center justify-center h-full text-gray-500">
                    <span class="material-symbols-outlined text-4xl mb-2">touch_app</span>
                    <p>Selecciona un instrumento a la izquierda</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Bar -->
    <div x-show="selectedInstrument && selectedStaging" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="translate-y-full opacity-0"
         x-transition:enter-end="translate-y-0 opacity-100"
         class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-900 border border-purple-500 rounded-full shadow-2xl px-8 py-3 flex items-center space-x-6 z-50">
        
        <div class="flex flex-col text-sm">
            <span class="text-gray-400">Acción:</span>
            <span class="font-bold text-white">Conciliar Selección</span>
        </div>

        <button 
            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-full flex items-center shadow-lg transform hover:scale-105 transition-all"
            hx-post="/reconciliation/match-manual"
            hx-vals='js:{instrument_id: selectedInstrument, staging_id: selectedStaging}'
            hx-target="body"
        >
            <span class="material-symbols-outlined mr-2">link</span>
            Confirmar Match
        </button>

        <button @click="selectedInstrument = null; selectedStaging = null" class="text-gray-400 hover:text-white">
            <span class="material-symbols-outlined">close</span>
        </button>
    </div>

</div>
{% endblock %}
